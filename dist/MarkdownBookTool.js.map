{"version":3,"sources":["../src/MarkdownBookTool.js"],"names":["MarkdownBookTool","autobind","constructor","container","toolName","log","debug","run","argv","options","boolean","string","alias","o","p","args","version","info","fullVersion","help","bookPath","_","Error","outputPath","files","title","number","JSON5","parse","fs","readFile","Array","isArray","tmpPath","tempy","file","extension","bookDir","path","resolve","dirname","writeFile","numbering","createSectionNumber","depth","s","length","push","pop","repeat","i","filePath","isAbsolute","markdown","encoding","replace","match","p1","appendFile","move","overwrite"],"mappings":"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","sourcesContent":["import parseArgs from \"minimist\"\nimport autobind from \"autobind-decorator\"\nimport * as version from \"./version\"\nimport JSON5 from \"@johnls/json5\"\nimport tempy from \"tempy\"\nimport fs from \"fs-extra\"\nimport path from \"path\"\n\n@autobind\nexport class MarkdownBookTool {\n  constructor(container) {\n    this.toolName = container.toolName\n    this.log = container.log\n    this.debug = !!container.debug\n  }\n\n  async run(argv) {\n    const options = {\n      boolean: [\"help\", \"version\"],\n      string: [\"output\", \"pdf\"],\n      alias: {\n        o: \"output\",\n        p: \"pdf\",\n      },\n    }\n\n    const args = parseArgs(argv, options)\n\n    if (args.version) {\n      this.log.info(version.fullVersion)\n      return 0\n    }\n\n    if (args.help) {\n      this.log.info(`\nUsage: ${this.toolName} [options] <book-definition-file>\n\nDescription:\n\nCreates a book from Markdown files.  Supply a JSON5 file list all the\nMarkdown files in the book in order.\n\nOptions:\n  --help                        Shows this help.\n  --version                     Shows the tool version.\n  --output <file>, -o <file>    Markdown output file. Required.\n  --pdf <file>, -p <file>       Generate a PDF as the output.\n`)\n      return 0\n    }\n\n    const bookPath = args._[0]\n\n    if (!bookPath) {\n      throw new Error(\"A book definition file must be specified\")\n    }\n\n    const outputPath = args[\"output\"]\n\n    if (!outputPath) {\n      throw new Error(\"An output path must be specified\")\n    }\n\n    this.log.info(`Processing ${bookPath}`)\n    const { files, title, number } = JSON5.parse(await fs.readFile(bookPath))\n\n    if (!files || !Array.isArray(files)) {\n      throw new Error(\"No files array property specified\")\n    }\n\n    const tmpPath = tempy.file({ extension: \"md\" })\n    const bookDir = path.resolve(path.dirname(bookPath))\n\n    fs.writeFile(tmpPath, `# ${title || \"Unknown\"}\\n\\n`)\n\n    let numbering = []\n    const createSectionNumber = (depth, numbering) => {\n      let s = \"\"\n\n      if (depth === numbering.length + 1) {\n        numbering.push(1)\n      } else if (depth === numbering.length) {\n        numbering[depth - 1] += 1\n      } else if (depth === numbering.length - 1) {\n        numbering.pop()\n        numbering[numbering.length - 1] += 1\n      } else {\n        return \"#\".repeat(depth + 1) + \"?.?.?: \"\n      }\n\n      for (let i = 1; i <= numbering.length; i++) {\n        s += numbering[i - 1] + (i !== numbering.length ? \".\" : \"\")\n      }\n\n      return \"#\".repeat(depth + 1) + \" \" + s + \": \"\n    }\n\n    for (let filePath of files) {\n      if (!path.isAbsolute(filePath)) {\n        filePath = path.resolve(bookDir, filePath)\n      }\n\n      let markdown = await fs.readFile(filePath, { encoding: \"utf8\" })\n\n      // Re-write the headings\n      markdown = markdown.replace(/^(#+) /gm, (match, p1) => {\n        const depth = p1.length\n\n        return \"#\" + p1 + numbering\n          ? createSectionNumber(depth, numbering)\n          : \" \"\n      })\n\n      // Insert a title and ensure file ends with a blank line\n      markdown += \"\\n\"\n\n      fs.appendFile(tmpPath, markdown)\n    }\n\n    fs.move(tmpPath, outputPath, { overwrite: true })\n\n    return 0\n  }\n}\n"],"file":"MarkdownBookTool.js"}